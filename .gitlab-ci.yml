variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - build
  - test
  - pages

## Build stage ###################################################################
.build:
  stage: build
  script:
    - ./bootstrap
    - ./configure --disable-tests --disable-docs
    - make
  artifacts:
    when: on_failure
    expire_in: 1 week
    paths:
    - config.log

build-debian-stable:
  extends: .build
  image: registry.labs.nic.cz/turris/updater/updater:debian

build-debian-unstable:
  extends: .build
  image: registry.labs.nic.cz/turris/updater/updater:tests

build-alpine:
  extends: .build
  image: registry.labs.nic.cz/turris/updater/updater:alpine

## Test stage ####################################################################
.test:
  stage: test
  image: registry.labs.nic.cz/turris/updater/updater:tests
  before_script:
      - ./bootstrap
      - ./configure
  artifacts:
    expire_in: 1 week
    paths:
    - test-suite*.log
    - tests/*/*.log
    - tests/*/*.trs

check:
  extends: .test
  script:
    - make check

# TODO valgrind test
# TODO luacheck
# TODO cppcheck

## Pages stage ###################################################################
pages:
  stage: pages
  image: registry.labs.nic.cz/turris/updater/updater:tests
  script:
  - rm -rf public
  - mkdir public
  - make COV=y
  - make COV=y test test-sys
  - make COV=y coverage
  - markdown .doc_index.md > public/index.html
  - utils/gendocindex.sh | markdown > public/docindex.html
  - cp -r docs public/docs
  - cp -r coverage public/coverage
  artifacts:
    when: on_success
    paths:
    - public
  only:
  - master
